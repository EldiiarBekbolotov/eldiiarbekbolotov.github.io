<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EldiiarGPT</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: black;
            font-family: 'Roboto', sans-serif;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chat-container {
            width: 90%;
            max-width: 600px;
            background: #111;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 80vh;
        }

        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .user {
            align-self: flex-end;
            background: #0b84ff;
        }

        .bot {
            align-self: flex-start;
            background: #333;
        }

        .input-container {
            display: flex;
            border-top: 1px solid #444;
        }

        #chat-input {
            flex: 1;
            padding: 10px;
            border: none;
            outline: none;
            background: #222;
            color: white;
            font-size: 16px;
        }

        #send-btn {
            padding: 10px 20px;
            border: none;
            background: #0b84ff;
            color: white;
            cursor: pointer;
        }

        #send-btn:hover {
            background: #006fce;
        }
    </style>
</head>

<body>
    <div class="chat-container">
        <div id="chat-messages"></div>
        <div class="input-container">
            <input id="chat-input" placeholder="Type your message..." />
            <button id="send-btn">Send</button>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const STORAGE_KEY = 'eldiiarGPTChat';

        // Load message history from localStorage
        let messages = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

        function renderMessages() {
            chatMessages.innerHTML = '';
            messages.forEach(msg => {
                const div = document.createElement('div');
                div.classList.add('message', msg.role);
                div.textContent = msg.content;
                chatMessages.appendChild(div);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage(content) {
            if (!content) return;

            // Add user message
            messages.push({ role: 'user', content });
            trimMessages();
            renderMessages();
            chatInput.value = '';

            try {
                const res = await fetch('https://eldiiar.netlify.app/.netlify/functions/chatWithGroq', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages }) // send full history
                });

                const data = await res.json();
                const botReply = data.choices?.[0]?.message?.content || 'No response';

                // Add AI reply
                messages.push({ role: 'bot', content: botReply });
                trimMessages();
                renderMessages();
                saveMessages();
            } catch (err) {
                console.error(err);
                messages.push({ role: 'bot', content: 'Error: Could not reach AI' });
                trimMessages();
                renderMessages();
                saveMessages();
            }
        }

        function trimMessages() {
            if (messages.length > 25) messages = messages.slice(messages.length - 25);
        }

        function saveMessages() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
        }

        // Event listeners
        sendBtn.addEventListener('click', () => sendMessage(chatInput.value));
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(chatInput.value); });

        // Render previous messages
        renderMessages();
    </script>

</body>

</html>